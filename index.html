<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bags.fm Token Deploy ‚Äì Final</title>

<style>
body { font-family: Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 20px }
label { display:block; margin-top:12px; font-weight:bold }
input, textarea, button { width:100%; padding:10px; margin-top:4px }
button { background:#007bff; color:#fff; border:none; cursor:pointer; font-size:16px }
button:disabled { background:#aaa }
#status {
  margin-top:20px;
  padding:15px;
  background:#f0f8ff;
  border-radius:8px;
  white-space:pre-wrap;
  font-family:monospace;
  max-height:500px;
  overflow:auto
}
.error { background:#ffebee; color:#c62828 }
</style>

<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>

<body>

<h2>Deploy Token no Bags.fm</h2>

<button id="connectBtn">Conectar Phantom</button>
<p id="walletStatus">Wallet: n√£o conectada</p>

<form id="deployForm">
  <label>API Key (bags.fm)</label>
  <input id="apiKeyInput" required>

  <label>Nome do Token</label>
  <input id="nameInput" required>

  <label>S√≠mbolo</label>
  <input id="symbolInput" maxlength="8" required>

  <label>Descri√ß√£o</label>
  <textarea id="descriptionInput"></textarea>

  <label>Imagem (PNG/JPG)</label>
  <input type="file" id="imageInput" accept="image/*" required>

  <label>Compra inicial (SOL)</label>
  <input type="number" id="initialBuyInput" step="0.001" value="0">

  <button id="deployBtn" disabled>Deploy</button>
</form>

<div id="status">Aguardando a√ß√£o...</div>

<script>
const { Connection, PublicKey, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

let provider = null;
let walletPubkey = null;

const statusDiv = document.getElementById("status");
function log(msg, isError=false) {
  statusDiv.textContent += "\n" + msg;
  if (isError) statusDiv.classList.add("error");
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

/* CONNECT WALLET */
document.getElementById("connectBtn").onclick = async () => {
  provider = window.phantom?.solana;
  if (!provider) return log("‚ùå Phantom n√£o detectada", true);

  await provider.connect();
  walletPubkey = provider.publicKey;
  document.getElementById("walletStatus").innerText =
    "Wallet: " + walletPubkey.toBase58();

  document.getElementById("deployBtn").disabled = false;
  log("‚úÖ Wallet conectada");
};

/* DEPLOY FLOW */
document.getElementById("deployForm").onsubmit = async (e) => {
  e.preventDefault();

  try {
    const apiKey = document.getElementById("apiKeyInput").value.trim();
    const tokenName = document.getElementById("nameInput").value.trim();
    const tokenSymbol = document.getElementById("symbolInput").value.trim().toUpperCase();
    const tokenDescription =
      document.getElementById("descriptionInput").value.trim() || "Token";
    const imageFile = document.getElementById("imageInput").files[0];
    const initialBuyLamports =
      Math.floor((+document.getElementById("initialBuyInput").value || 0) * LAMPORTS_PER_SOL);

    if (!apiKey || !tokenName || !tokenSymbol || !imageFile)
      throw new Error("Campos obrigat√≥rios n√£o preenchidos");

    /* PASSO 1 ‚Äî CREATE TOKEN INFO */
    log("Passo 1: Criando metadata...");
    const formData = new FormData();
    formData.append("name", tokenName);
    formData.append("symbol", tokenSymbol);
    formData.append("description", tokenDescription);
    formData.append("image", imageFile);

    const infoRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method: "POST", headers: { "x-api-key": apiKey }, body: formData }
    );

    const infoData = await infoRes.json();
    if (!infoRes.ok || !infoData.success) throw infoData;

    const tokenMint = infoData.response.tokenMint;
    const metadataUrl = infoData.response.tokenMetadata;

    log("‚úÖ Mint: " + tokenMint);

    /* PASSO 2 ‚Äî CREATE CONFIG (CORRETO) */
    log("Passo 2: Fee config...");
    const configRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-config",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify({
          launchWallet: walletPubkey.toBase58()
        })
      }
    );

    const configData = await configRes.json();
    if (!configRes.ok || !configData.success) throw configData;

    const configTx = Transaction.from(bs58.decode(configData.response));
    const signedConfig = await provider.signTransaction(configTx);
    const configSig = await connection.sendRawTransaction(
      signedConfig.serialize()
    );
    await connection.confirmTransaction(configSig, "confirmed");

    log("‚úÖ Fee config OK: " + configSig);

    /* PASSO 3 ‚Äî LAUNCH TOKEN */
    log("Passo 3: Launch token...");
    const launchRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify({
          payer: walletPubkey.toBase58(),
          tokenMint: tokenMint,
          metadataUrl: metadataUrl,
          initialBuyLamports: initialBuyLamports
        })
      }
    );

    const launchData = await launchRes.json();
    if (!launchRes.ok || !launchData.success) throw launchData;

    const launchTx = Transaction.from(bs58.decode(launchData.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const launchSig = await connection.sendRawTransaction(
      signedLaunch.serialize()
    );
    await connection.confirmTransaction(launchSig, "confirmed");

    log("üéâ DEPLOY CONCLU√çDO COM SUCESSO!");
    log("TX: " + launchSig);
    log("Bags: https://bags.fm/" + tokenMint);

  } catch (err) {
    log(
      "‚ùå ERRO:\n" +
      (err?.message || JSON.stringify(err, null, 2)),
      true
    );
  }
};
</script>

</body>
</html>
