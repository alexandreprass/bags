<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bags.fm Deploy ‚Äì Resiliente</title>

<style>
body { font-family: Arial; max-width: 760px; margin: 40px auto; padding: 20px }
label { display:block; margin-top:12px; font-weight:bold }
input, textarea, button { width:100%; padding:10px; margin-top:4px }
button { background:#007bff; color:#fff; border:none; font-size:16px; cursor:pointer }
button:disabled { background:#aaa }
#status {
  margin-top:20px;
  padding:15px;
  background:#f0f8ff;
  white-space:pre-wrap;
  font-family:monospace;
  max-height:500px;
  overflow:auto
}
.error { background:#ffebee; color:#c62828 }
</style>

<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>

<body>

<h2>Bags.fm Token Deploy (Resiliente)</h2>

<button id="connectBtn">Conectar Phantom</button>
<p id="walletStatus">Wallet: n√£o conectada</p>

<form id="form">
  <label>API Key</label>
  <input id="apiKeyInput" required>

  <label>Nome</label>
  <input id="nameInput" required>

  <label>S√≠mbolo</label>
  <input id="symbolInput" maxlength="8" required>

  <label>Descri√ß√£o</label>
  <textarea id="descriptionInput"></textarea>

  <label>Imagem</label>
  <input type="file" id="imageInput" accept="image/*" required>

  <label>Compra inicial (SOL)</label>
  <input type="number" id="initialBuyInput" step="0.001" value="0">

  <button id="deployBtn" disabled>Deploy</button>
</form>

<div id="status">Aguardando a√ß√£o...</div>

<script>
const { Connection, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com");

let provider, wallet;
const statusDiv = document.getElementById("status");

function log(msg, err=false){
  statusDiv.textContent += "\n" + msg;
  if(err) statusDiv.classList.add("error");
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

async function fetchJsonSafe(res){
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch {
    throw new Error(
      "Backend Bags.fm indispon√≠vel (HTML 500 / Cloudflare)\n\n" +
      "Tente novamente em alguns minutos."
    );
  }
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

document.getElementById("connectBtn").onclick = async () => {
  provider = window.phantom?.solana;
  if(!provider) return log("‚ùå Phantom n√£o encontrada", true);
  await provider.connect();
  wallet = provider.publicKey;
  document.getElementById("walletStatus").innerText = wallet.toBase58();
  document.getElementById("deployBtn").disabled = false;
  log("‚úÖ Wallet conectada");
};

document.getElementById("form").onsubmit = async e => {
  e.preventDefault();

  try {
    const apiKey = apiKeyInput.value.trim();
    const name = nameInput.value.trim();
    const symbol = symbolInput.value.trim().toUpperCase();
    const desc = descriptionInput.value.trim() || "Token";
    const image = imageInput.files[0];
    const buyLamports =
      Math.floor((+initialBuyInput.value || 0) * LAMPORTS_PER_SOL);

    log("Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", name);
    fd.append("symbol", symbol);
    fd.append("description", desc);
    fd.append("image", image);

    const infoRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method:"POST", headers:{ "x-api-key":apiKey }, body:fd }
    );

    const info = await fetchJsonSafe(infoRes);
    if(!info.success) throw info;

    const { tokenMint, tokenMetadata } = info.response;
    log("‚úÖ Mint: " + tokenMint);

    log("‚è≥ Aguardando backend estabilizar...");
    await sleep(3000);

    log("Passo 2: Tentando launch...");
    const launchRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-api-key":apiKey
        },
        body: JSON.stringify({
          payer: wallet.toBase58(),
          tokenMint,
          metadataUrl: tokenMetadata,
          initialBuyLamports: buyLamports
        })
      }
    );

    const launch = await fetchJsonSafe(launchRes);
    if(!launch.success) throw launch;

    const tx = Transaction.from(bs58.decode(launch.response));
    const signed = await provider.signTransaction(tx);
    const sig = await connection.sendRawTransaction(signed.serialize());

    log("üéâ DEPLOY ENVIADO");
    log("TX: " + sig);
    log("https://bags.fm/" + tokenMint);

  } catch(err) {
    log("‚ùå " + err.message, true);
  }
};
</script>

</body>
</html>
