<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bags.fm Token Deploy (Corrigido)</title>

  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 40px auto; padding: 20px; }
    label { display: block; margin: 12px 0 4px; font-weight: bold; }
    input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; }
    button { background: #007bff; color: #fff; border: none; font-size: 16px; cursor: pointer; }
    button:disabled { background: #aaa; }
    #status {
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 500px;
      overflow-y: auto;
    }
    .error { background: #ffebee; color: #c62828; }
  </style>

  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>

<body>

<h1>Deploy Token no Bags.fm</h1>

<button id="connectWalletBtn">Conectar Phantom</button>
<p id="walletStatus">Wallet: n√£o conectada</p>

<form id="tokenForm">
  <label>API Key (bags.fm)</label>
  <input id="apiKey" required>

  <label>Nome do Token</label>
  <input id="name" required>

  <label>S√≠mbolo</label>
  <input id="symbol" maxlength="8" required>

  <label>Descri√ß√£o</label>
  <textarea id="description" rows="3"></textarea>

  <label>Imagem</label>
  <input type="file" id="imageFile" accept="image/*" required>

  <label>Compra inicial (SOL)</label>
  <input type="number" id="initialBuy" step="0.001" value="0">

  <button id="submitBtn" disabled>Criar e Deploy</button>
</form>

<div id="status">Aguardando a√ß√£o...</div>

<script>
const { Connection, PublicKey, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

let provider, publicKey;

const statusDiv = document.getElementById("status");
const walletStatus = document.getElementById("walletStatus");
const submitBtn = document.getElementById("submitBtn");

function log(msg, error=false) {
  statusDiv.innerHTML += "\n" + msg;
  if (error) statusDiv.classList.add("error");
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

document.getElementById("connectWalletBtn").onclick = async () => {
  provider = window.phantom?.solana;
  if (!provider) return log("‚ùå Phantom n√£o detectada", true);

  await provider.connect();
  publicKey = new PublicKey(provider.publicKey.toString());
  walletStatus.innerText = `Wallet: ${publicKey.toBase58()}`;
  submitBtn.disabled = false;
  log("‚úÖ Wallet conectada");
};

document.getElementById("tokenForm").onsubmit = async (e) => {
  e.preventDefault();

  try {
    const apiKey = apiKey.value.trim();
    const name = name.value.trim();
    const symbol = symbol.value.trim().toUpperCase();
    const description = description.value.trim() || "Token";
    const image = imageFile.files[0];
    const initialBuyLamports = Math.floor((+initialBuy.value || 0) * LAMPORTS_PER_SOL);

    /* PASSO 1 ‚Äî METADATA */
    log("üöÄ Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", name);
    fd.append("symbol", symbol);
    fd.append("description", description);
    fd.append("image", image);

    const infoRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method: "POST", headers: { "x-api-key": apiKey }, body: fd }
    );

    const info = await infoRes.json();
    if (!info.success) throw info;

    const tokenMint = info.response.tokenMint;
    const metadataUrl = info.response.tokenMetadata;

    log("‚úÖ Mint: " + tokenMint);

    /* PASSO 2 ‚Äî FEE CONFIG (CORRIGIDO) */
    log("‚öôÔ∏è Passo 2: Configurando fee share...");

    const feeBody = {
      launchWallet: publicKey.toBase58(),
      tokenMint: tokenMint,
      feeShare: [
        { wallet: publicKey.toBase58(), bps: 10000 }
      ]
    };

    const feeRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-config",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify(feeBody)
      }
    );

    const feeData = await feeRes.json();
    if (!feeRes.ok) throw feeData;

    const feeTx = Transaction.from(bs58.decode(feeData.response));
    const signedFee = await provider.signTransaction(feeTx);
    const feeSig = await connection.sendRawTransaction(signedFee.serialize());
    await connection.confirmTransaction(feeSig);
    log("‚úÖ Fee config tx: " + feeSig);

    /* PASSO 3 ‚Äî LAUNCH */
    log("üî• Passo 3: Launch token...");

    const launchRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify({
          payer: publicKey.toBase58(),
          tokenMint,
          metadataUrl,
          initialBuyLamports
        })
      }
    );

    const launchData = await launchRes.json();
    if (!launchRes.ok) throw launchData;

    const launchTx = Transaction.from(bs58.decode(launchData.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const sig = await connection.sendRawTransaction(signedLaunch.serialize());
    await connection.confirmTransaction(sig);

    log("üéâ DEPLOY CONCLU√çDO!");
    log("TX: " + sig);
    log("https://bags.fm/" + tokenMint);

  } catch (err) {
    log("‚ùå ERRO:\n" + JSON.stringify(err, null, 2), true);
  }
};
</script>

</body>
</html>
