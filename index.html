<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bags.fm Deploy ‚Äì Vers√£o Est√°vel</title>
    <style>
        body { font-family: 'Segoe UI', Arial; max-width: 600px; margin: 40px auto; padding: 20px; background: #f4f7f9; }
        .card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        label { display:block; margin-top:15px; font-weight:bold; color: #333; }
        input, textarea, button { width:100%; padding:12px; margin-top:6px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background:#007bff; color:#fff; border:none; font-size:16px; cursor:pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        button:disabled { background:#ccc; cursor: not-allowed; }
        #status { margin-top:20px; padding:15px; background:#1e1e1e; color: #00ff00; border-radius: 8px; white-space:pre-wrap; font-family:monospace; font-size: 13px; max-height:300px; overflow:auto; }
        .error { color: #ff5252 !important; }
    </style>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>
<body>

<div class="card">
    <h2>Bags.fm Token Deploy</h2>
    <button id="connectBtn">1. Conectar Phantom</button>
    <p id="walletStatus" style="font-size: 12px; color: #666; margin-top: 5px;">Wallet: n√£o conectada</p>

    <form id="form">
        <label>API Key (dev.bags.fm)</label>
        <input id="apiKeyInput" placeholder="Sua chave API" required>

        <label>Nome do Token</label>
        <input id="nameInput" placeholder="Ex: Solana Moon" required>

        <label>S√≠mbolo</label>
        <input id="symbolInput" maxlength="8" placeholder="Ex: MOON" required>

        <label>Descri√ß√£o</label>
        <textarea id="descriptionInput" rows="2"></textarea>

        <label>Imagem (Logo)</label>
        <input type="file" id="imageInput" accept="image/*" required>

        <label>Compra Inicial (SOL)</label>
        <input type="number" id="initialBuyInput" step="0.001" value="0.01">

        <button id="deployBtn" style="margin-top: 20px;" disabled>2. Lan√ßar Token</button>
    </form>

    <div id="status">Aguardando conex√£o...</div>
</div>

<script>
const { Connection, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

let provider, wallet;
const statusDiv = document.getElementById("status");

function log(msg, isError = false) {
    const span = document.createElement("div");
    if (isError) span.className = "error";
    span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    statusDiv.appendChild(span);
    statusDiv.scrollTop = statusDiv.scrollHeight;
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

document.getElementById("connectBtn").onclick = async () => {
    provider = window.phantom?.solana;
    if(!provider) return log("‚ùå Phantom n√£o encontrada!", true);
    try {
        await provider.connect();
        wallet = provider.publicKey;
        document.getElementById("walletStatus").innerText = "Conectado: " + wallet.toBase58();
        document.getElementById("deployBtn").disabled = false;
        log("‚úÖ Wallet conectada com sucesso.");
    } catch (e) { log("‚ùå Erro ao conectar: " + e.message, true); }
};

document.getElementById("form").onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById("deployBtn");
    btn.disabled = true;
    statusDiv.textContent = "";

    try {
        const apiKey = document.getElementById("apiKeyInput").value.trim();
        const buyLamports = Math.floor((+document.getElementById("initialBuyInput").value || 0) * LAMPORTS_PER_SOL);

        // PASSO 1: Metadata
        log("üöÄ Passo 1: Criando metadata...");
        const fd = new FormData();
        fd.append("name", document.getElementById("nameInput").value);
        fd.append("symbol", document.getElementById("symbolInput").value.toUpperCase());
        fd.append("description", document.getElementById("descriptionInput").value || "Bags Token");
        fd.append("image", document.getElementById("imageInput").files[0]);

        const infoRes = await fetch("https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info", {
            method: "POST",
            headers: { "x-api-key": apiKey },
            body: fd
        });

        const info = await infoRes.json();
        if (!info.success) throw new Error(info.message || "Falha no Passo 1");

        const { tokenMint, tokenMetadata } = info.response;
        log(`‚úÖ Token criado no banco: ${tokenMint}`);

        // ESPERA CR√çTICA: Aumentada para 15 segundos
        log("‚è≥ Aguardando 15s para indexa√ß√£o no backend...");
        await sleep(15000);

        // PASSO 2: Launch Transaction com Retry
        let launchData = null;
        for (let i = 1; i <= 3; i++) {
            log(`üöÄ Passo 2: Gerando transa√ß√£o (Tentativa ${i}/3)...`);
            const launchRes = await fetch("https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-api-key": apiKey },
                body: JSON.stringify({
                    payer: wallet.toBase58(),
                    tokenMint: tokenMint,
                    metadataUrl: tokenMetadata,
                    initialBuyLamports: buyLamports.toString(), // Enviando como String
                    feeShares: [] // Adicionado para compatibilidade V2
                })
            });

            if (launchRes.ok) {
                launchData = await launchRes.json();
                break;
            } else {
                const errorText = await launchRes.text();
                log(`‚ö†Ô∏è Falha na tentativa ${i}. Aguardando mais...`, true);
                await sleep(5000);
                if (i === 3) throw new Error("Backend Bags.fm continua inst√°vel (Erro 500). Tente novamente mais tarde.");
            }
        }

        if (!launchData || !launchData.success) throw new Error("Falha ao gerar transa√ß√£o.");

        // PASSO 3: Assinar e Enviar
        log("‚úçÔ∏è Assinando transa√ß√£o na Phantom...");
        const tx = Transaction.from(bs58.decode(launchData.response));
        const signed = await provider.signTransaction(tx);
        
        log("üì° Enviando para a rede Solana...");
        const sig = await connection.sendRawTransaction(signed.serialize(), { skipPreflight: false });
        
        log("üéâ SUCESSO ABSOLUTO!");
        log("Assinatura (TX): " + sig);
        log(`Link: https://solscan.io/tx/${sig}`);
        alert("Token lan√ßado com sucesso!");

    } catch (err) {
        log("‚ùå ERRO: " + err.message, true);
        console.error(err);
    } finally {
        btn.disabled = false;
    }
};
</script>
</body>
</html>
