<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bags.fm Deploy - FUNCIONA 100%</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 720px; margin: 40px auto; padding: 20px; }
    label { font-weight: bold; margin-top: 12px; display: block; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 6px; }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; }
    button:disabled { background: #ccc; }
    #status { margin-top: 20px; background: #f5f5f5; padding: 15px; white-space: pre-wrap; font-family: monospace; max-height: 500px; overflow-y: auto; }
    .error { background: #ffe6e6; }
  </style>
</head>
<body>
<h2>Deploy Token no Bags.fm (FUNCIONA AGORA!)</h2>
<button id="connect">Conectar Phantom</button>
<p id="wallet">Wallet: desconectada</p>
<form id="form">
  <label>API Key (cole aqui)</label>
  <input id="apiKey" required>
  <label>Nome</label>
  <input id="name" required>
  <label>S√≠mbolo (m√°x 8 letras)</label>
  <input id="symbol" maxlength="8" required>
  <label>Descri√ß√£o</label>
  <textarea id="desc" placeholder="Descri√ß√£o do token"></textarea>
  <label>Imagem</label>
  <input type="file" id="image" accept="image/*" required>
  <label>Compra inicial (SOL) - pode deixar 0</label>
  <input type="number" id="buy" step="0.001" value="0">
  <label>Seu % de fees (10000 = 100%)</label>
  <input type="number" id="creatorBps" min="0" max="10000" value="10000">
  <button type="submit" disabled id="deploy">Deploy</button>
</form>
<div id="status">Aguardando...</div>

<script>
const { Connection, Transaction, PublicKey, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");
const FEE_SHARE_PROGRAM = new PublicKey("FEE2tBhCKAt7shrod19QttSVREUYPiyMzoku1mL1gqVK");

let provider, wallet;
const status = document.getElementById("status");
const log = (msg, err = false) => {
  status.innerHTML += "\n" + msg;
  status.scrollTop = status.scrollHeight;
  if (err) status.className = "error";
};

async function fetchWithRetry(url, options, retries = 5) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url, options);
      const text = await res.text();
      log(`Tentativa ${i+1} - ${res.status} - Preview: ${text.slice(0,200)}...`);
      const json = JSON.parse(text);
      if (!res.ok) throw new Error(json.error || `HTTP ${res.status}`);
      return json;
    } catch (e) {
      log(`‚ö†Ô∏è Erro (tent ${i+1}): ${e.message}`, true);
      if (i === retries - 1) throw e;
      await new Promise(r => setTimeout(r, 2000 * (i+1)));
    }
  }
}

document.getElementById("connect").onclick = async () => {
  provider = window.phantom?.solana;
  if (!provider) return log("Phantom n√£o encontrada", true);
  await provider.connect();
  wallet = provider.publicKey;
  document.getElementById("wallet").innerText = "Wallet: " + wallet.toBase58();
  document.getElementById("deploy").disabled = false;
  log("‚úÖ Wallet conectada: " + wallet.toBase58());
};

document.getElementById("form").onsubmit = async e => {
  e.preventDefault();
  status.innerHTML = "";
  status.className = "";
  try {
    const apiKey = document.getElementById("apiKey").value.trim();
    const name = document.getElementById("name").value.trim();
    const symbol = document.getElementById("symbol").value.trim().toUpperCase();
    const desc = document.getElementById("desc").value.trim() || "Launched via Bags.fm";
    const image = document.getElementById("image").files[0];
    const buyLamports = Math.floor((parseFloat(document.getElementById("buy").value) || 0) * LAMPORTS_PER_SOL);
    const creatorBps = parseInt(document.getElementById("creatorBps").value) || 10000;

    if (!apiKey || !name || !symbol || !image) throw new Error("Preencha API Key, nome, s√≠mbolo e imagem");

    log("Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", name);
    fd.append("symbol", symbol);
    fd.append("description", desc);
    fd.append("image", image);

    const meta = await fetchWithRetry(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method: "POST", headers: { "x-api-key": apiKey }, body: fd }
    );
    const mintStr = meta.response.tokenMint;
    const metadataUrl = meta.response.tokenMetadata;
    log("‚úÖ Mint: " + mintStr);

    log("Passo 1.5: Criando Fee Share Config...");
    const feeBody = {
      payer: wallet.toBase58(),
      baseMint: mintStr,
      claimersArray: [   // <--- CAMPO CORRETO (era feeClaimers antes!)
        {
          user: wallet.toBase58(),
          userBps: creatorBps
        }
      ]
    };

    const feeRes = await fetchWithRetry(
      "https://public-api-v2.bags.fm/api/v1/fee-share/config",
      {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-api-key": apiKey },
        body: JSON.stringify(feeBody)
      }
    );

    const txSerialized = feeRes.response;
    log("‚úÖ Tx de config recebida (preview): " + txSerialized.substring(0,80) + "...");

    const configTx = Transaction.from(bs58.decode(txSerialized));
    const signedConfig = await provider.signTransaction(configTx);
    const configSig = await connection.sendRawTransaction(signedConfig.serialize());
    await connection.confirmTransaction(configSig, "confirmed");
    log("‚úÖ Fee Share Config criada e confirmada: " + configSig);

    const [configPda] = PublicKey.findProgramAddressSync(
      [Buffer.from("fee_share_config"), new PublicKey(mintStr).toBuffer()],
      FEE_SHARE_PROGRAM
    );
    const configKey = configPda.toBase58();
    log("‚úÖ Config Key: " + configKey);

    log("Passo 2: Criando launch transaction...");
    const launchRes = await fetchWithRetry(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-api-key": apiKey },
        body: JSON.stringify({
          tokenMint: mintStr,
          metadataUrl: metadataUrl,
          payer: wallet.toBase58(),
          initialBuyLamports: buyLamports,
          configKey: configKey
        })
      }
    );

    const launchTx = Transaction.from(bs58.decode(launchRes.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const sig = await connection.sendRawTransaction(signedLaunch.serialize());
    await connection.confirmTransaction(sig, "confirmed");

    log("üéâ DEPLOY CONCLU√çDO COM SUCESSO!");
    log("Signature: https://solscan.io/tx/" + sig);
    log("Token: https://bags.fm/" + mintStr);
    log("Abra agora: https://bags.fm/" + mintStr);
  } catch (err) {
    log("‚ùå ERRO: " + err.message, true);
  }
};
</script>
</body>
</html>
