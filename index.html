<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bags.fm Deploy ‚Äì Vers√£o Est√°vel</title>
<style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; background: #f9f9f9; }
    .container { background: #fff; padding: 20px; border-radius: 8px; shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display:block; margin-top:12px; font-weight:bold }
    input, textarea, button { width:100%; padding:10px; margin-top:4px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { background:#007bff; color:#fff; border:none; font-size:16px; cursor:pointer; font-weight: bold; }
    button:disabled { background:#aaa }
    #status { margin-top:20px; padding:15px; background:#222; color:#0f0; white-space:pre-wrap; font-family:monospace; max-height:400px; overflow:auto; border-radius: 4px; }
    .error { color:#ff4d4d; }
</style>
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>
<body>

<div class="container">
    <h2>Bags.fm Token Deploy (V2)</h2>
    <button id="connectBtn">1. Conectar Phantom</button>
    <p id="walletStatus" style="font-size: 12px; color: #666;">Wallet: n√£o conectada</p>

    <form id="form">
        <label>API Key</label>
        <input id="apiKeyInput" type="password" placeholder="Insira sua chave da Bags" required>

        <label>Nome do Token</label>
        <input id="nameInput" placeholder="Ex: Solana Dog" required>

        <label>S√≠mbolo</label>
        <input id="symbolInput" maxlength="8" placeholder="Ex: DOG" required>

        <label>Descri√ß√£o</label>
        <textarea id="descriptionInput" placeholder="Conte sobre o projeto..."></textarea>

        <label>Imagem</label>
        <input type="file" id="imageInput" accept="image/*" required>

        <label>Compra inicial (SOL)</label>
        <input type="number" id="initialBuyInput" step="0.001" value="0.01">

        <button id="deployBtn" style="margin-top:20px" disabled>2. Lan√ßar Token</button>
    </form>

    <div id="status">Console: Aguardando a√ß√£o...</div>
</div>

<script>
const { Connection, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com");

let provider, wallet;
const statusDiv = document.getElementById("status");

function log(msg, err=false){
    const time = new Date().toLocaleTimeString();
    const line = document.createElement("div");
    if(err) line.className = "error";
    line.textContent = `[${time}] ${msg}`;
    statusDiv.appendChild(line);
    statusDiv.scrollTop = statusDiv.scrollHeight;
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

document.getElementById("connectBtn").onclick = async () => {
    provider = window.phantom?.solana;
    if(!provider) return log("‚ùå Phantom n√£o encontrada", true);
    await provider.connect();
    wallet = provider.publicKey;
    document.getElementById("walletStatus").innerText = "Wallet: " + wallet.toBase58();
    document.getElementById("deployBtn").disabled = false;
    log("‚úÖ Wallet conectada");
};

document.getElementById("form").onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById("deployBtn");
    btn.disabled = true;
    
    try {
        const apiKey = apiKeyInput.value.trim();
        const buyLamports = Math.floor((+initialBuyInput.value || 0) * LAMPORTS_PER_SOL);

        log("Passo 1: Criando metadata...");
        const fd = new FormData();
        fd.append("name", nameInput.value.trim());
        fd.append("symbol", symbolInput.value.trim().toUpperCase());
        fd.append("description", descriptionInput.value.trim() || "Bags Token");
        fd.append("image", imageInput.files[0]);

        const infoRes = await fetch("https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info", {
            method:"POST", 
            headers:{ "x-api-key":apiKey }, 
            body:fd 
        });

        const info = await infoRes.json();
        if(!info.success) throw new Error(info.message || "Falha ao criar metadata");

        const { tokenMint, tokenMetadata } = info.response;
        log("‚úÖ Mint ID gerado: " + tokenMint);

        // DELAY DE SEGURAN√áA AUMENTADO (Para o banco de dados indexar)
        log("‚è≥ Aguardando 10 segundos para estabiliza√ß√£o do backend...");
        await sleep(10000);

        log("Passo 2: Gerando transa√ß√£o de lan√ßamento...");
        
        let launchResponse;
        let attempts = 0;
        const maxAttempts = 3;

        while(attempts < maxAttempts) {
            attempts++;
            const res = await fetch("https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction", {
                method:"POST",
                headers:{ "Content-Type":"application/json", "x-api-key":apiKey },
                body: JSON.stringify({
                    payer: wallet.toBase58(),
                    tokenMint,
                    metadataUrl: tokenMetadata,
                    initialBuyLamports: buyLamports.toString(), // Enviado como String
                    feeShares: [{ wallet: wallet.toBase58(), percentage: 100 }] // Define voc√™ como recebedor de 100% das taxas
                })
            });

            if(res.ok) {
                launchResponse = await res.json();
                break;
            } else {
                log(`‚ö†Ô∏è Tentativa ${attempts} falhou (Erro ${res.status}). Tentando novamente em 5s...`, true);
                if(attempts >= maxAttempts) throw new Error("Backend Bags.fm indispon√≠vel ap√≥s 3 tentativas.");
                await sleep(5000);
            }
        }

        if(!launchResponse.success) throw new Error(launchResponse.message);

        log("‚úçÔ∏è Assinando transa√ß√£o...");
        const tx = Transaction.from(bs58.decode(launchResponse.response));
        const signed = await provider.signTransaction(tx);
        
        log("üì° Enviando para a blockchain...");
        const sig = await connection.sendRawTransaction(signed.serialize());

        log("üéâ TOKEN LAN√áADO COM SUCESSO!");
        log("Assinatura (TX): " + sig);
        log("Visualize em: https://bags.fm/" + tokenMint);

    } catch(err) {
        log("‚ùå ERRO: " + err.message, true);
        console.error(err);
    } finally {
        btn.disabled = false;
    }
};
</script>
</body>
</html>
