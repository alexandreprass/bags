<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bags.fm Deploy ‚Äì FIX FINAL</title>

<style>
body { font-family: Arial; max-width: 720px; margin: 40px auto; padding: 20px }
label { display:block; margin-top:12px; font-weight:bold }
input, textarea, button { width:100%; padding:10px; margin-top:4px }
button { background:#007bff; color:#fff; border:none; cursor:pointer }
button:disabled { background:#aaa }
#status { margin-top:20px; padding:15px; background:#f0f8ff; white-space:pre-wrap; font-family:monospace; max-height:500px; overflow:auto }
.error { background:#ffebee; color:#c62828 }
</style>

<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>

<body>

<h2>Deploy Token Bags.fm</h2>

<button id="connectBtn">Conectar Phantom</button>
<p id="walletStatus">Wallet: desconectada</p>

<form id="form">
  <label>API Key</label>
  <input id="apiKeyInput" required>

  <label>Nome</label>
  <input id="nameInput" required>

  <label>S√≠mbolo</label>
  <input id="symbolInput" maxlength="8" required>

  <label>Descri√ß√£o</label>
  <textarea id="descriptionInput"></textarea>

  <label>Imagem</label>
  <input type="file" id="imageInput" accept="image/*" required>

  <label>Compra inicial (SOL)</label>
  <input type="number" id="initialBuyInput" step="0.001" value="0">

  <button id="deployBtn" disabled>Deploy</button>
</form>

<div id="status">Aguardando a√ß√£o...</div>

<script>
const { Connection, PublicKey, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com");

let provider, wallet;

const statusDiv = document.getElementById("status");
function log(msg, err=false){
  statusDiv.textContent += "\n" + msg;
  if(err) statusDiv.classList.add("error");
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

document.getElementById("connectBtn").onclick = async () => {
  provider = window.phantom?.solana;
  if(!provider) return log("‚ùå Phantom n√£o encontrada", true);

  await provider.connect();
  wallet = provider.publicKey;
  document.getElementById("walletStatus").innerText = "Wallet: " + wallet.toBase58();
  document.getElementById("deployBtn").disabled = false;
  log("‚úÖ Wallet conectada");
};

document.getElementById("form").onsubmit = async (e) => {
  e.preventDefault();

  try {
    const apiKey = document.getElementById("apiKeyInput").value.trim();
    const name = document.getElementById("nameInput").value.trim();
    const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();
    const description = document.getElementById("descriptionInput").value.trim() || "Token";
    const image = document.getElementById("imageInput").files[0];
    const initialBuyLamports =
      Math.floor((+document.getElementById("initialBuyInput").value || 0) * LAMPORTS_PER_SOL);

    if(!apiKey || !name || !symbol || !image)
      throw new Error("Campos obrigat√≥rios faltando");

    /* PASSO 1 */
    log("Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", name);
    fd.append("symbol", symbol);
    fd.append("description", description);
    fd.append("image", image);

    const infoRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method:"POST", headers:{ "x-api-key": apiKey }, body:fd }
    );

    const info = await infoRes.json();
    if(!info.success) throw info;

    const tokenMint = info.response.tokenMint;
    const metadataUrl = info.response.tokenMetadata;
    log("Mint: " + tokenMint);

    /* PASSO 2 */
    log("Passo 2: Fee config...");
    const feeRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-config",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-api-key":apiKey
        },
        body: JSON.stringify({
          launchWallet: wallet.toBase58(),
          tokenMint,
          feeShare:[{ wallet: wallet.toBase58(), bps:10000 }]
        })
      }
    );

    const feeData = await feeRes.json();
    if(!feeRes.ok) throw feeData;

    const feeTx = Transaction.from(bs58.decode(feeData.response));
    const signedFee = await provider.signTransaction(feeTx);
    await connection.sendRawTransaction(signedFee.serialize());
    log("Fee OK");

    /* PASSO 3 */
    log("Passo 3: Launch...");
    const launchRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-api-key":apiKey
        },
        body: JSON.stringify({
          payer: wallet.toBase58(),
          tokenMint,
          metadataUrl,
          initialBuyLamports
        })
      }
    );

    const launchData = await launchRes.json();
    if(!launchRes.ok) throw launchData;

    const launchTx = Transaction.from(bs58.decode(launchData.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const sig = await connection.sendRawTransaction(signedLaunch.serialize());

    log("üéâ DEPLOY FINALIZADO");
    log("TX: " + sig);
    log("https://bags.fm/" + tokenMint);

  } catch(err) {
    log("‚ùå ERRO REAL:\n" + (err.message || JSON.stringify(err, null, 2)), true);
  }
};
</script>

</body>
</html>
