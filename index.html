<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bags.fm Token Deploy ‚Äì Robust</title>

<style>
body { font-family: Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 20px }
label { display:block; margin-top:12px; font-weight:bold }
input, textarea, button { width:100%; padding:10px; margin-top:4px }
button { background:#007bff; color:#fff; border:none; cursor:pointer; font-size:16px }
button:disabled { background:#aaa }
#status {
  margin-top:20px;
  padding:15px;
  background:#f0f8ff;
  border-radius:8px;
  white-space:pre-wrap;
  font-family:monospace;
  max-height:500px;
  overflow:auto
}
.error { background:#ffebee; color:#c62828 }
</style>

<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
</head>

<body>

<h2>Deploy Token no Bags.fm (Robusto)</h2>

<button id="connectBtn">Conectar Phantom</button>
<p id="walletStatus">Wallet: n√£o conectada</p>

<form id="deployForm">
  <label>API Key</label>
  <input id="apiKeyInput" required>

  <label>Nome do Token</label>
  <input id="nameInput" required>

  <label>S√≠mbolo</label>
  <input id="symbolInput" maxlength="8" required>

  <label>Descri√ß√£o</label>
  <textarea id="descriptionInput"></textarea>

  <label>Imagem</label>
  <input type="file" id="imageInput" accept="image/*" required>

  <label>Compra inicial (SOL)</label>
  <input type="number" id="initialBuyInput" step="0.001" value="0">

  <button id="deployBtn" disabled>Deploy</button>
</form>

<div id="status">Aguardando a√ß√£o...</div>

<script>
const { Connection, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

let provider = null;
let walletPubkey = null;

const statusDiv = document.getElementById("status");
function log(msg, err=false){
  statusDiv.textContent += "\n" + msg;
  if(err) statusDiv.classList.add("error");
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

async function safeFetchJson(res) {
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch {
    throw new Error(
      "Resposta N√ÉO JSON do Bags.fm:\n\n" +
      text.slice(0, 800)
    );
  }
}

/* CONNECT */
document.getElementById("connectBtn").onclick = async () => {
  provider = window.phantom?.solana;
  if (!provider) return log("‚ùå Phantom n√£o encontrada", true);

  await provider.connect();
  walletPubkey = provider.publicKey;

  document.getElementById("walletStatus").innerText =
    "Wallet: " + walletPubkey.toBase58();

  document.getElementById("deployBtn").disabled = false;
  log("‚úÖ Wallet conectada");
};

/* DEPLOY */
document.getElementById("deployForm").onsubmit = async (e) => {
  e.preventDefault();

  try {
    const apiKey = apiKeyInput.value.trim();
    const tokenName = nameInput.value.trim();
    const tokenSymbol = symbolInput.value.trim().toUpperCase();
    const tokenDescription = descriptionInput.value.trim() || "Token";
    const imageFile = imageInput.files[0];
    const initialBuyLamports =
      Math.floor((+initialBuyInput.value || 0) * LAMPORTS_PER_SOL);

    if(!apiKey || !tokenName || !tokenSymbol || !imageFile)
      throw new Error("Campos obrigat√≥rios faltando");

    /* PASSO 1 */
    log("Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", tokenName);
    fd.append("symbol", tokenSymbol);
    fd.append("description", tokenDescription);
    fd.append("image", imageFile);

    const infoRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method:"POST", headers:{ "x-api-key":apiKey }, body:fd }
    );

    const info = await safeFetchJson(infoRes);
    if(!info.success) throw info;

    const tokenMint = info.response.tokenMint;
    const metadataUrl = info.response.tokenMetadata;
    log("‚úÖ Mint: " + tokenMint);

    /* PASSO 2 */
    log("Passo 2: Launch token...");
    const launchRes = await fetch(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-api-key":apiKey
        },
        body: JSON.stringify({
          payer: walletPubkey.toBase58(),
          tokenMint,
          metadataUrl,
          initialBuyLamports
        })
      }
    );

    const launch = await safeFetchJson(launchRes);
    if(!launch.success) throw launch;

    const launchTx = Transaction.from(bs58.decode(launch.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const sig = await connection.sendRawTransaction(
      signedLaunch.serialize()
    );
    await connection.confirmTransaction(sig, "confirmed");

    log("üéâ DEPLOY CONCLU√çDO");
    log("TX: " + sig);
    log("https://bags.fm/" + tokenMint);

  } catch(err) {
    log("‚ùå ERRO REAL:\n" + err.message, true);
  }
};
</script>

</body>
</html>
