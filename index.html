<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bags.fm Token Deploy (v2 Fee Share - CORRIGIDO 500)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@5.0.0/dist/index.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 720px; margin: 40px auto; padding: 20px; }
    label { font-weight: bold; margin-top: 12px; display: block; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 6px; }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; }
    button:disabled { background: #ccc; }
    #status { margin-top: 20px; background: #f5f5f5; padding: 15px; white-space: pre-wrap; font-family: monospace; max-height: 500px; overflow-y: auto; }
    .error { background: #ffe6e6; }
  </style>
</head>
<body>
<h2>Deploy Token no Bags.fm (v2 - Fee Share com baseMint)</h2>
<button id="connect">Conectar Phantom</button>
<p id="wallet">Wallet: desconectada</p>
<form id="form">
  <label>API Key</label>
  <input id="apiKey" required>
  <label>Nome</label>
  <input id="name" required>
  <label>Símbolo</label>
  <input id="symbol" maxlength="8" required>
  <label>Descrição (obrigatória)</label>
  <textarea id="desc" placeholder="Descrição do token"></textarea>
  <label>Imagem</label>
  <input type="file" id="image" accept="image/*" required>
  <label>Compra inicial (SOL)</label>
  <input type="number" id="buy" step="0.001" value="0">
  <label>Seu % de fees (10000 = 100%, default)</label>
  <input type="number" id="creatorBps" min="0" max="10000" step="1" value="10000">
  <button type="submit" disabled id="deploy">Deploy</button>
</form>
<div id="status">Aguardando ação...</div>

<script>
const { Connection, Transaction, PublicKey, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");
const FEE_SHARE_PROGRAM_ID = new PublicKey("FEE2tBhCKAt7shrod19QttSVREUYPiyMzoku1mL1gqVK");

let provider, wallet;
const status = document.getElementById("status");
const log = (msg, err = false) => {
  status.innerHTML += "\n" + msg;
  status.scrollTop = status.scrollHeight;
  if (err) status.className = "error";
};

const apiKeyInput = document.getElementById("apiKey");
const nameInput = document.getElementById("name");
const symbolInput = document.getElementById("symbol");
const descInput = document.getElementById("desc");
const imageInput = document.getElementById("image");
const buyInput = document.getElementById("buy");
const creatorBpsInput = document.getElementById("creatorBps");

async function fetchWithRetry(url, options, retries = 5) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url, options);
      const text = await res.text();
      log(`Tentativa ${i+1} - Status: ${res.status} - Body preview: ${text.substring(0, 150)}...`);
      try {
        const json = JSON.parse(text);
        if (!res.ok) throw new Error(json.message || json.error || `HTTP ${res.status}`);
        return json;
      } catch (parseErr) {
        log(`⚠️ Não JSON (tentativa ${i+1}): ${text}`, true);
        if (i === retries - 1) throw new Error(`Resposta final: ${text}`);
        await new Promise(r => setTimeout(r, 2000 * (i + 1)));
      }
    } catch (err) {
      if (i === retries - 1) throw err;
    }
  }
}

document.getElementById("connect").onclick = async () => {
  provider = window.phantom?.solana;
  if (!provider) return log("Phantom não detectada", true);
  await provider.connect();
  wallet = provider.publicKey;
  document.getElementById("wallet").innerText = "Wallet: " + wallet.toBase58();
  document.getElementById("deploy").disabled = false;
  log("✅ Wallet conectada");
};

document.getElementById("form").onsubmit = async e => {
  e.preventDefault();
  status.innerHTML = "";
  status.className = "";
  try {
    const apiKey = apiKeyInput.value.trim();
    const name = nameInput.value.trim();
    const symbol = symbolInput.value.trim().toUpperCase();
    const desc = descInput.value.trim() || "Token launched via Bags.fm";
    const image = imageInput.files[0];
    const buyLamports = Math.floor((parseFloat(buyInput.value) || 0) * LAMPORTS_PER_SOL);
    const creatorBps = parseInt(creatorBpsInput.value) || 10000;

    if (!apiKey || !name || !symbol || !image) throw new Error("Campos obrigatórios não preenchidos");

    log("Passo 1: Criando metadata...");
    const fd = new FormData();
    fd.append("name", name);
    fd.append("symbol", symbol);
    fd.append("description", desc);
    fd.append("image", image);

    const meta = await fetchWithRetry(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-token-info",
      { method: "POST", headers: { "x-api-key": apiKey }, body: fd }
    );
    const mintStr = meta.response.tokenMint;
    const metadataUrl = meta.response.tokenMetadata;
    log("✅ Mint: " + mintStr);

    log("Passo 1.5: Criando Fee Share Config transaction (com baseMint)...");
    const feeShareBody = {
      payer: wallet.toBase58(),
      baseMint: mintStr,  // ← ESSENCIAL! Resolve provável causa do 500
      feeClaimers: [{
        user: wallet.toBase58(),
        userBps: creatorBps
      }]
      // opcional: tipWallet, tipLamports
    };

    let configEndpoint = "https://public-api-v2.bags.fm/api/v1/fee-share/config";
    let configTxRes = await fetchWithRetry(
      configEndpoint,
      {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-api-key": apiKey },
        body: JSON.stringify(feeShareBody)
      }
    );

    // Se der 404/500 persistente, descomente e teste este alternativo:
    // configEndpoint = "https://public-api-v2.bags.fm/api/v1/token-launch/fee-share/create-config";
    // configTxRes = await fetchWithRetry(... mesmo body);

    let serializedTx = configTxRes.response;  // assume direto base58
    if (configTxRes.response && configTxRes.response.transaction) {
      serializedTx = configTxRes.response.transaction;
    }
    log("Tx serializada recebida (preview): " + serializedTx.substring(0, 50) + "...");

    const configTx = Transaction.from(bs58.decode(serializedTx));
    const signedConfigTx = await provider.signTransaction(configTx);
    const configSig = await connection.sendRawTransaction(signedConfigTx.serialize(), { skipPreflight: false });
    await connection.confirmTransaction(configSig, "confirmed");
    log("✅ Fee Share Config tx confirmada: " + configSig);

    // Derivar PDA configKey
    const [configKeyPda] = PublicKey.findProgramAddressSync(
      [Buffer.from("fee_share_config"), new PublicKey(mintStr).toBuffer()],
      FEE_SHARE_PROGRAM_ID
    );
    const configKey = configKeyPda.toBase58();
    log("✅ Config Key (PDA): " + configKey);

    log("Passo 2: Criando launch transaction...");
    const launch = await fetchWithRetry(
      "https://public-api-v2.bags.fm/api/v1/token-launch/create-launch-transaction",
      {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-api-key": apiKey },
        body: JSON.stringify({
          tokenMint: mintStr,
          metadataUrl: metadataUrl,
          payer: wallet.toBase58(),
          initialBuyLamports: buyLamports,
          configKey: configKey
          // opcional: tipWallet, tipLamports
        })
      }
    );

    const launchTx = Transaction.from(bs58.decode(launch.response));
    const signedLaunch = await provider.signTransaction(launchTx);
    const launchSig = await connection.sendRawTransaction(signedLaunch.serialize());
    await connection.confirmTransaction(launchSig, "confirmed");

    log("✅ DEPLOY CONCLUÍDO!");
    log("Launch Tx: " + launchSig);
    log("Token: https://bags.fm/" + mintStr);
  } catch (err) {
    log("❌ ERRO REAL: " + (err.message || err.stack || err), true);
  }
};
</script>
</body>
</html>
